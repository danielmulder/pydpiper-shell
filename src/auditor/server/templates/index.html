<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PydPiper Studio</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root { --sidebar-width: 360px; --primary-color: #2c3e50; --accent-color: #3498db; --bg-color: #f4f6f9; --border-color: #e1e4e8; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: var(--bg-color); color: #333; }

        /* --- SIDEBAR STRUCTURE --- */
        #sidebar { width: var(--sidebar-width); background: white; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }

        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border-color); background: #f8f9fa; }
        .tab-btn { flex: 1; padding: 12px 0; border: none; background: transparent; cursor: pointer; color: #666; font-weight: 600; font-size: 0.85em; border-bottom: 3px solid transparent; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .tab-btn i { font-size: 1.2em; margin-bottom: 2px; }
        .tab-btn:hover { background: #eef2f7; color: var(--primary-color); }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); background: white; }

        .sidebar-view { flex: 1; overflow-y: auto; display: none; display: flex; flex-direction: column; }
        .sidebar-view:not(.active) { display: none !important; }

        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }

        /* --- RIBBON / TOOLBAR --- */
        .sidebar-toolbar { padding: 8px 12px; border-bottom: 1px solid var(--border-color); background: #fff; display: flex; gap: 8px; align-items: center; height: 40px; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .tool-btn { border: 1px solid transparent; background: transparent; color: #555; cursor: pointer; border-radius: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .tool-btn:hover { background: #eef2f7; color: var(--accent-color); border-color: #dee2e6; }
        .tool-btn i { font-size: 1.2em; }
        .ribbon-sep { width: 1px; height: 20px; background: #eee; margin: 0 4px; }
        .ribbon-search { flex: 1; border: 1px solid #e1e4e8; background: #f8f9fa; border-radius: 4px; padding: 5px 10px; font-size: 0.85em; color: #333; outline: none; transition: all 0.2s; }
        .ribbon-search:focus { background: #fff; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(52,152,219,0.1); }

        /* --- CONTENT AREA --- */
        #content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.25s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- SHARED UI --- */
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .header-card { display: flex; justify-content: space-between; align-items: center; }
        .stat-badge { background: #eef2f7; padding: 8px 15px; border-radius: 5px; font-weight: 600; color: var(--primary-color); margin-right: 10px; display: inline-flex; align-items: center; gap: 8px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background-color: #f8f9fa; color: #666; font-weight: 600; font-size: 0.85em; text-transform: uppercase; }
        tr:hover { background-color: #f9f9f9; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75em; color: white; font-weight: bold; text-transform: uppercase; }
        .sev-CRITICAL { background-color: #e74c3c; }
        .sev-WARNING { background-color: #f39c12; }
        .sev-INFO { background-color: #3498db; }
        .cat-badge { background-color: #6c757d; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; }
        .code-cell { font-family: 'Consolas', monospace; font-size: 0.9em; background: #eee; padding: 2px 5px; border-radius: 3px; color: #c7254e; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: 'Consolas', monospace; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9em; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-success { background-color: #2ecc71; color: white; }

        /* --- N-GRAM STYLES --- */
        .ngram-tag {
            display: inline-block;
            background: #f1f3f5;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            margin: 2px;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        .ngram-count {
            background: #adb5bd;
            color: white;
            border-radius: 50%;
            padding: 0 5px;
            font-size: 0.8em;
            margin-left: 5px;
            min-width: 15px;
            display: inline-block;
            text-align: center;
        }

        /* --- ISSUES.HTML SPECIFIC STYLES (INTEGRATED) --- */
        .stats-grid { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid transparent; }
        .stat-card h4 { margin: 0 0 5px 0; font-size: 0.8em; text-transform: uppercase; color: #888; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 2em; font-weight: bold; color: #2c3e50; }
        .stat-card.total { border-left-color: #2c3e50; }
        .stat-card.critical { border-left-color: #dc3545; }
        .stat-card.warning { border-left-color: #ffc107; }

        .progress-container { background: #eee; height: 8px; border-radius: 4px; width: 100px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 10px; }
        .progress-bar { height: 100%; }

        .badge-critical { background: #ffecec; color: #dc3545; }
        .badge-warning { background: #fff8dd; color: #ffc107; }
        .badge-info { background: #e3f2fd; color: #3498db; }

        .nav-btn { text-decoration: none; padding: 2px 6px; background: #eef2f7; border-radius: 5px; color: var(--primary-color); font-weight: 600; font-size: 0.8em; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .nav-btn:hover { background: #dfe6ed; }

        a { text-decoration: none; color: #3498db; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-tabs">
        <button class="tab-btn active" onclick="switchTab('explore')"><i class="ri-file-search-line"></i> Explore</button>
        <button class="tab-btn" onclick="switchTab('issues')"><i class="ri-bug-line"></i> Issues</button>
        <button class="tab-btn" onclick="switchTab('config')"><i class="ri-settings-3-line"></i> Config</button>
    </div>

    <div id="nav_explore" class="sidebar-view active">
        <div class="sidebar-toolbar">
            <button class="tool-btn" onclick="showExploreDashboard()" title="Go to Project Dashboard"><i class="ri-home-4-line"></i></button>
            <div class="ribbon-sep"></div>
            <input type="text" id="tree_q_explore" class="ribbon-search" placeholder="Filter pages...">
            <button class="tool-btn" onclick="$('#tree_explore').jstree('clear_search'); $('#tree_q_explore').val('')" title="Clear"><i class="ri-close-circle-line" style="color:#aaa;"></i></button>
        </div>
        <div class="sidebar-content"><div id="tree_explore"></div></div>
    </div>

    <div id="nav_issues" class="sidebar-view">
        <div class="sidebar-toolbar">
            <button class="tool-btn" onclick="$('#tree_issues').jstree('open_all')" title="Expand All"><i class="ri-expand-up-down-line"></i></button>
            <button class="tool-btn" onclick="$('#tree_issues').jstree('close_all')" title="Collapse All"><i class="ri-contract-up-down-line"></i></button>
            <div class="ribbon-sep"></div>
            <input type="text" id="tree_q_issues" class="ribbon-search" placeholder="Filter issues...">
        </div>
        <div class="sidebar-content"><div id="tree_issues"></div></div>
    </div>

    <div id="nav_config" class="sidebar-view">
        <div class="sidebar-toolbar">
            <button class="tool-btn" onclick="saveConfig()" title="Save Configuration" style="color:var(--accent-color);"><i class="ri-save-line"></i></button>
            <div class="ribbon-sep"></div>
            <span style="font-size:0.9em; color:#333;">Settings</span>
        </div>
        <div class="sidebar-content">
            <div class="card" style="padding: 15px; cursor: pointer; background: #eef2f7; border:none;" onclick="$('#config_scroll').get(0).scrollIntoView()">
                <div style="font-weight:bold; margin-bottom:5px;"><i class="ri-eye-off-line"></i> Ignore Lists</div>
                <div style="font-size:0.8em; color:#666;">Manage patterns for images and links.</div>
            </div>
        </div>
    </div>
</div>

<div id="content">
    <div id="loading" style="display:none; text-align: center; margin-top: 50px; color:#777;">
        <h2><i class="ri-loader-4-line ri-spin"></i> Processing...</h2>
    </div>

    <div id="view_explore" class="view-section active">
        <div class="card header-card">
            <div>
                <h1 style="margin:0;">{% if project.name is defined %} {{ project.name }} {% else %} Project {{ project.id }} {% endif %}</h1>
                <p style="margin:5px 0 0 0; color:#666;"><a href="{{ project.start_url }}" target="_blank" style="color:var(--accent-color); text-decoration:none;">{{ project.start_url }}</a></p>
            </div>
            <div>
                <span class="stat-badge"><i class="ri-file-line"></i> <span id="total_pages">0</span> Pages</span>
                <span class="stat-badge"><i class="ri-bug-line"></i> <span id="total_issues">0</span> Issues</span>
                <button onclick="window.location.href='/api/export'" class="btn btn-success" style="padding: 5px 15px;"><i class="ri-file-excel-2-line"></i> Export</button>
            </div>
        </div>

        <div id="explore_overview">
            <div class="card">
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">Audit Overview</h3>
                <table id="summary_table">
                    <thead><tr><th>Category</th><th>Issue Code</th><th style="text-align:right;">Count</th><th>Severity</th></tr></thead>
                    <tbody><tr><td colspan="4"><i class="ri-loader-2-line ri-spin"></i> Loading data...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="explore_details" style="display:none;">
            <div class="card" style="border-left: 5px solid var(--accent-color);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h2 style="margin:0; word-break: break-all;" id="page_url"></h2>
                        <div style="display:flex; gap:20px; color:#555; margin-top:5px;">
                            <span><strong>ID:</strong> <span id="page_id"></span></span>
                            <span><strong>Status:</strong> <span id="page_status"></span></span>
                        </div>
                    </div>
                    <button onclick="showExploreDashboard()" class="btn" style="background:#eee;">Close Details</button>
                </div>
            </div>

            <div id="ngram_overview" class="card" style="display:none;">
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1em; color:#555;">
                    <i class="ri-text-spacing"></i> Content Insights (Top Keywords)
                </h3>
                <div style="display:flex; gap: 20px;">
                    <div style="flex:1;">
                        <h4 style="font-size:0.8em; text-transform:uppercase; color:#888;">Unigrams</h4>
                        <div id="list_unigrams"></div>
                    </div>
                    <div style="flex:1;">
                        <h4 style="font-size:0.8em; text-transform:uppercase; color:#888;">Bigrams</h4>
                        <div id="list_bigrams"></div>
                    </div>
                    <div style="flex:1;">
                        <h4 style="font-size:0.8em; text-transform:uppercase; color:#888;">Trigrams</h4>
                        <div id="list_trigrams"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">Findings on this page</h3>
                <table id="page_issues_table">
                    <thead><tr><th width="80">Severity</th><th>Category</th><th>Element</th><th>Code</th><th>Message</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view_issues" class="view-section">
        <div id="issues_placeholder" style="text-align: center; color: #aaa; margin-top: 100px;">
            <i class="ri-price-tag-3-line" style="font-size: 4em;"></i>
            <h2>Select a category or issue to view details</h2>
        </div>

        <div id="category_report" style="display:none;">
            <div class="card header-card">
                <div>
                    <h1 style="margin:0;"><i class="ri-folder-open-line text-info"></i> <span id="cat_report_title">Category</span></h1>
                    <p style="margin:5px 0 0 0; color:#666;">Aggregated statistics for this category</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card total"><h4>Total Issues</h4><div class="value" id="stat_total">0</div></div>
                <div class="stat-card critical"><h4>Critical Errors</h4><div class="value" id="stat_critical" style="color: #dc3545">0</div></div>
                <div class="stat-card warning"><h4>Warnings</h4><div class="value" id="stat_warning" style="color: #ffc107">0</div></div>
            </div>

            <div class="card">
                <h3>Issue Breakdown</h3>
                <table id="cat_breakdown_table">
                    <thead><tr><th width="100">Severity</th><th>Issue Code</th><th>Distribution</th><th width="80" style="text-align:right;">Count</th><th width="50">Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="issue_details" style="display:none;">
            <div class="card header-card">
                <div>
                    <h2 style="margin:0;"><span id="issue_code"></span></h2>
                    <p><strong>Category:</strong> <span id="issue_cat"></span></p>
                </div>
            </div>
            <div class="card">
                <p style="margin-bottom: 15px;">Showing affected pages:</p>
                <table id="urls_table">
                    <thead><tr><th width="50">ID</th><th width="300">URL</th><th width="60">Stat</th><th>Message</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view_config" class="view-section">
        <div class="card" id="config_scroll">
            <h2 style="margin-top:0;"><i class="ri-settings-3-line"></i> Audit Configuration</h2>
            <div class="form-group">
                <label class="form-label">Ignored Images (Comma separated)</label>
                <textarea id="cfg_img" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Ignored Links (Comma separated)</label>
                <textarea id="cfg_link" class="form-control" rows="4"></textarea>
            </div>
            <button onclick="saveConfig()" class="btn btn-primary"><i class="ri-save-line"></i> Save Configuration</button>
        </div>
    </div>
</div>

<script>
    // --- TABS ---
    function switchTab(tabName) {
        $('.tab-btn').removeClass('active');
        $(`.tab-btn[onclick="switchTab('${tabName}')"]`).addClass('active');
        $('.sidebar-view').removeClass('active');
        $(`#nav_${tabName}`).addClass('active');
        $('.view-section').removeClass('active');
        $(`#view_${tabName}`).addClass('active');

        if(tabName === 'issues') loadIssueTree();
        if(tabName === 'config') loadConfig();
    }

    // --- EXPLORE LOGIC (Existing) ---
    function showExploreDashboard() { $('#explore_details').hide(); $('#explore_overview').fadeIn(); $('#tree_explore').jstree('deselect_all'); }

    $(document).ready(function() {
        loadDashboardData();
        initExploreTree();

        // Listener for buttons inside the category table
        $(document).on('click', '.view-issue-btn', function(e) {
            e.preventDefault(); e.stopPropagation();
            var nodeId = $(this).attr('data-node-id');
            var tree = $('#tree_issues').jstree(true);
            if(nodeId && tree) {
                tree.deselect_all();
                tree.reveal_node(nodeId);
                tree.select_node(nodeId);
            }
        });
    });

    function loadDashboardData() {
        $.get("/api/report?name=scan_result", function(response) {
            if (response && response.data) {
                if(response.data.summary) {
                    $('#total_pages').text(response.data.summary.pages_analyzed);
                    $('#total_issues').text(response.data.summary.total_issues);
                }
                var tbody = $('#summary_table tbody'); tbody.empty();
                var breakdown = response.data.breakdown || [];
                if (breakdown.length === 0) {
                    tbody.html('<tr><td colspan="4" style="text-align:center; padding:20px; color:green;">No issues found.</td></tr>');
                } else {
                    breakdown.forEach(function(item) {
                        tbody.append(`<tr><td><span class="cat-badge">${item.category}</span></td><td style="font-weight:bold;">${item.code}</td><td style="text-align:right;">${item.count}</td><td>${getSevBadge(item.code)}</td></tr>`);
                    });
                }
            }
        });
    }

    function initExploreTree() {
        $.get("/api/tree", function(response) {
            $('#tree_explore').jstree({
                'core': { 'data': response.tree_data, 'themes': { 'responsive': false, 'stripes': true } },
                "plugins" : [ "search", "types" ]
            });
            $('#tree_q_explore').keyup(function () {
                var v = $(this).val(); setTimeout(function () { $('#tree_explore').jstree(true).search(v); }, 250);
            });
            $('#tree_explore').on("changed.jstree", function (e, data) {
                if(data.selected.length) {
                    var node = data.instance.get_node(data.selected[0]);
                    if (node.data && node.data.page_id) loadPageDetails(node.data.page_id);
                    else showExploreDashboard();
                }
            });
        });
    }

    function loadPageDetails(pageId) {
        $('#explore_overview').hide(); $('#explore_details').show();
        $('#page_issues_table tbody').html('<tr><td colspan="5">Loading...</td></tr>');

        // Hide ngram box while loading
        $('#ngram_overview').hide();

        $.get("/api/page/" + pageId, function(data) {
            $('#page_url').html(`<a href="${data.url}" target="_blank">${data.url} <i class="ri-external-link-line"></i></a>`);
            $('#page_id').text(data.id);
            var sColor = (data.status_code >= 200 && data.status_code < 300) ? 'green' : 'red';
            $('#page_status').text(data.status_code).css('color', sColor);

            // --- N-GRAM RENDER LOGIC ---
            if (data.ngrams) {
                renderNgrams('#list_unigrams', data.ngrams.meta_unigrams, 5);
                renderNgrams('#list_bigrams', data.ngrams.meta_bigrams, 3);
                renderNgrams('#list_trigrams', data.ngrams.meta_trigrams, 3);
                $('#ngram_overview').show();
            } else {
                $('#ngram_overview').hide();
            }

            // Issues Table
            var tbody = $('#page_issues_table tbody'); tbody.empty();
            if (!data.issues || data.issues.length === 0) tbody.append('<tr><td colspan="5">No issues!</td></tr>');
            else {
                data.issues.forEach(function(issue) {
                    tbody.append(`<tr><td><span class="badge sev-${issue.severity}">${issue.severity}</span></td><td>${issue.category}</td><td><span class="code-cell">${issue.element_type||'-'}</span></td><td><span class="code-cell">${issue.issue_code}</span></td><td>${issue.message}</td></tr>`);
                });
            }
        });
    }

    function renderNgrams(targetId, dataObj) {
        var container = $(targetId);
        container.empty();
        if(!dataObj || Object.keys(dataObj).length === 0) {
            container.html('<span style="color:#ccc; font-style:italic; font-size:0.9em;">No data</span>');
            return;
        }
        // Sorteer op value (count) descending en pak top 10
        var sorted = Object.keys(dataObj).map(function(key) {
            return [key, dataObj[key]];
        }).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);

        sorted.forEach(function(item) {
            container.append(`<span class="ngram-tag">${item[0]} <span class="ngram-count">${item[1]}</span></span>`);
        });
    }

    // --- ISSUES LOGIC (INTEGRATED) ---
    var issuesTreeLoaded = false;
    function loadIssueTree() {
        if(issuesTreeLoaded) return;
        $.get("/api/issues/tree", function(data) {
            $('#tree_issues').jstree({
                'core': { 'data': data, 'themes': { 'responsive': false } },
                'types': { 'default': { 'icon': 'ri-folder-line' }, 'file': { 'icon': 'ri-file-warning-line' } },
                "plugins" : [ "search", "types" ]
            });
            $('#tree_q_issues').keyup(function () {
                var v = $(this).val(); setTimeout(function () { $('#tree_issues').jstree(true).search(v); }, 250);
            });
            $('#tree_issues').on("changed.jstree", function (e, data) {
                if(data.selected.length) {
                    var node = data.instance.get_node(data.selected[0]);
                    // Check leaf (Issue) vs folder (Category)
                    // The backend sends 'type': 'issue' in node.data for leaves
                    if (node.data && node.data.type === 'issue') {
                        loadIssueDetails(node.data.category, node.data.code);
                    } else {
                        loadCategoryReport(node);
                    }
                }
            });
            issuesTreeLoaded = true;
        });
    }

    function loadCategoryReport(node) {
        $('#issues_placeholder').hide(); $('#issue_details').hide(); $('#category_report').show();
        $('#cat_report_title').text(node.text);

        var total = 0, critical = 0, warning = 0, issues = [];
        var childrenIds = node.children; // IDs of children in JSTree

        childrenIds.forEach(function(id) {
            var child = $('#tree_issues').jstree(true).get_node(id);
            if(!child) return;
            // Data zit in child.data (vanuit backend)
            var d = child.data;
            // Fallback als data leeg is (zou niet moeten met nieuwe backend)
            if(!d) return;

            var sev = 'INFO';
            if(d.code.includes('MISSING') || d.code.includes('BROKEN')) sev = 'CRITICAL';
            else if(d.code.includes('EMPTY') || d.code.includes('TOO')) sev = 'WARNING';

            if(sev === 'CRITICAL') critical += d.count;
            if(sev === 'WARNING') warning += d.count;
            total += d.count;

            issues.push({ code: d.code, count: d.count, severity: sev, id: id });
        });

        $('#stat_total').text(total);
        $('#stat_critical').text(critical);
        $('#stat_warning').text(warning);

        var tbody = $('#cat_breakdown_table tbody'); tbody.empty();
        issues.sort((a, b) => b.count - a.count);

        issues.forEach(function(issue) {
            var badgeClass = issue.severity === 'CRITICAL' ? 'badge-critical' : (issue.severity === 'WARNING' ? 'badge-warning' : 'badge-info');
            var percent = total > 0 ? Math.round((issue.count / total) * 100) : 0;
            var barColor = issue.severity === 'CRITICAL' ? '#dc3545' : (issue.severity === 'WARNING' ? '#ffc107' : '#3498db');

            tbody.append(`<tr>
                <td><span class="badge ${badgeClass}">${issue.severity}</span></td>
                <td style="font-weight:500;">${issue.code}</td>
                <td><div class="progress-container"><div class="progress-bar" style="width: ${percent}%; background-color: ${barColor};"></div></div> <span style="font-size:0.85em; color:#888;">${percent}%</span></td>
                <td style="text-align:right; font-weight:bold;">${issue.count}</td>
                <td><button class="nav-btn view-issue-btn" type="button" data-node-id="${issue.id}">View</button></td>
            </tr>`);
        });
    }

    function loadIssueDetails(cat, code) {
        $('#issues_placeholder').hide(); $('#category_report').hide(); $('#issue_details').show();
        $('#issue_code').text(code); $('#issue_cat').text(cat);
        $('#urls_table tbody').html('<tr><td colspan="4"><i class="ri-loader-4-line ri-spin"></i> Loading...</td></tr>');

        $.get(`/api/issues/urls?cat=${encodeURIComponent(cat)}&code=${encodeURIComponent(code)}`, function(data) {
            var tbody = $('#urls_table tbody'); tbody.empty();
            if(!data || data.length === 0) {
                tbody.append('<tr><td colspan="4">No pages found.</td></tr>');
            } else {
                data.forEach(function(row) {
                    var statColor = row.status_code >= 400 ? 'red' : (row.status_code >= 300 ? 'orange' : 'green');
                    tbody.append(`<tr>
                        <td style="color:#999; font-size:0.85em;">${row.id}</td>
                        <td><a href="${row.url}" target="_blank" style="display:block; max-width:350px; overflow:hidden; text-overflow:ellipsis;">${row.url} <i class="ri-external-link-line"></i></a></td>
                        <td><span style="font-weight:bold; color:${statColor}">${row.status_code}</span></td>
                        <td style="color:#444;">${row.message}</td>
                    </tr>`);
                });
            }
        });
    }

    function loadConfig() {
        $.get("/api/config", function(data) {
            if(data && data.ignored_images) $('#cfg_img').val(data.ignored_images.join(', '));
            if(data && data.ignored_links) $('#cfg_link').val(data.ignored_links.join(', '));
        });
    }

    function saveConfig() {
        var imgs = $('#cfg_img').val().split(',').map(s => s.trim()).filter(s => s);
        var links = $('#cfg_link').val().split(',').map(s => s.trim()).filter(s => s);
        $.ajax({
            url: '/api/config', type: 'POST', contentType: 'application/json',
            data: JSON.stringify({ hidden: [], ignored_images: imgs, ignored_links: links }),
            success: function() { alert('Configuration saved!'); },
            error: function() { alert('Failed to save config.'); }
        });
    }

    function getSevBadge(code) {
        if (code.includes('MISSING') || code.includes('BROKEN') || code.includes('50')) return '<span class="badge sev-CRITICAL">High</span>';
        if (code.includes('EMPTY') || code.includes('TOO')) return '<span class="badge sev-WARNING">Medium</span>';
        return '<span class="badge sev-INFO">Info</span>';
    }
</script>
</body>
</html>